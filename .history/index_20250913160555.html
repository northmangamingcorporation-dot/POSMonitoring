<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <title>STI Northman Gaming - Data Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
      <!-- Toastr (requires jQuery) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <link rel="icon" type="image/jpeg" href="image/cancellationlogo.jpg">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/table.css">
    <link rel="stylesheet" href="css/searchBar.css">
    <link rel="stylesheet" href="css/modal.css">
    <script src="https://accounts.google.com/gsi/client" async defer ></script>
    <script src="js/databaseConnect.js"></script>
    <script src="js/dataManipulate.js"></script>
    <script src="js/dataFiltering.js"></script>
    <script src="js/auth-modal.js" defer></script>
</head>

<body onload='loadSheet("POS")'>
  <!-- Topbar (hidden initially) -->
  <div class="topbar" id="topbar">
    <img src="image/ITdeptDP.jpg" alt="Logo" class="logo">
    <span class="title">STI Northman Gaming</span>

    <!-- Links -->
<a id="linkAccomplishmentBtn" class="toggleBtn" data-label="Accomplishment Report">üìÑ Show Accomplishment Report</a>
<a id="linkReportBtn" class="toggleBtn" data-label="Report Analyzer">üìä Show Report Analyzer</a>
<a id="linkITMonitoringBtn" class="toggleBtn" data-label="IT Monitoring">üì∂ Go to IT Monitoring</a>

</div>

    <div class="sidebar" id="sidebar">
        <h2>STI Northman Gaming</h2>
        <div class="menu" id="menu"></div>
        
        <!-- User Profile -->
        <div id="userProfile" style="display: none; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
           margin-top: 16px; padding: 12px; border-radius: 12px; max-width: 320px;
           color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.2); overflow: hidden;">

            <!-- Profile Picture -->
            <img id="userPic" src="" alt="Profile Picture" style="width: 55px; height: 55px; border-radius: 50%; border: 3px solid white; flex-shrink: 0;">

            <div style="text-align: left; min-width: 0; flex: 1;">
                <div id="userName" style="font-weight: bold; font-size: 16px; letter-spacing: 0.3px;
           line-height: 1.0; word-wrap: break-word; overflow-wrap: anywhere; margin-bottom: 4px;"></div>

                <div id="userEmail" style="font-size: 13px; opacity: 0.9; font-style: italic;
               white-space: normal; word-wrap: break-word; overflow-wrap: anywhere;"></div>
            </div>
        </div>
        
        <!-- ‚úÖ Button to toggle report -->
        <button id="btnAccomplishmentBtn" class="toggleBtn" style="margin-top: 12px; padding: 8px 16px; border: none; border-radius: 6px; background: #007bff; color: white; cursor: pointer; width: 100%;">
            üìÑ Show Accomplishment Report
        </button>

        <!-- ‚úÖ Button to toggle report -->
        <button id="btnReportBtn" class="toggleBtn" style="margin-top: 12px; padding: 8px 16px; border: none; border-radius: 6px; background: #007bff; color: white; cursor: pointer; width: 100%;">
            üìä Show Report Analyzer
        </button>
        <!-- Redirect button -->
        <button id="btnITMonitoringBtn" class="toggleBtn" style="margin-top: 16px; padding: 8px 16px; border: none; border-radius: 6px; background: #28a745; color: white; cursor: pointer; width: 100%;">
            üì∂ Go to IT Monitoring
            </button>

    </div>

    <div class="main" id="main">
        <div class="loader" id="loader">
            <div class="spinner"></div>
        </div>
        <div class="card" id="tableCard">
            <h2 id="sheetTitle">Select a Sheet</h2>
            <div class="search-box" style="display: flex; gap: 8px; margin-top: 10px;">
                <input type="text" id="searchInput" placeholder="Search..." style="flex: 1;">
                <button id="addBtn" style="padding: 8px 16px; border: none; border-radius: 6px; background: #007bff; color: white; cursor: pointer;" onclick="openModal()">
          ‚ûï ADD ENTRY
        </button>
            </div>
            <div id="tableContainer"></div>

        </div>
        <!-- ‚úÖ Report Analyzer embedded -->
            <div class="card" id="reportCard" style="display: none;">
                <iframe id="mainIframe"  style="width: 100%; height: 800px; border: none; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);"></iframe>
            </div>
    </div>

    <!-- ‚úÖ Component -->
    <auth-modal></auth-modal>

    <!-- Hover effect -->
    <style>
        #modalAuthorizeBtn:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transform: translateY(-2px);
        }
    </style>

    <!-- Add Row Modal -->
    <div id="addModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2>Add New Row</h2>
            <form id="addRowForm"></form>
            <div class="modal-actions">
                <button type="button" onclick="saveNewRow()">üíæ Save</button>
                <button type="button" onclick="closeModal()">‚ùå Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let sheetpage = "";
        let addSheetName = "";
        let sheetDataCache = {};
        let currentEdit = null;

        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.getElementById('sidebar');
            const topbar = document.getElementById('topbar');
            const main = document.getElementById('main');

            // Click outside sidebar to hide
            document.addEventListener('click', (e) => {
                if (!sidebar.contains(e.target) && !topbar.contains(e.target)) {
                    sidebar.classList.add('hidden');
                    topbar.style.display = 'flex';
                    main.classList.add('full-width', 'topbar-visible');
                }
            });

            // Click topbar to show sidebar
            topbar.addEventListener('click', () => {
                sidebar.classList.remove('hidden');
                topbar.style.display = 'none';
                main.classList.remove('full-width', 'topbar-visible');
            });
        });


        // ------------------- Init -------------------
        window.onload = () => {
            initGIS();
        };
        // ------------------- User Profile -------------------
        async function loadUserProfile() {
            try {
                const res = await fetch("https://www.googleapis.com/oauth2/v3/userinfo", {
                    headers: {
                        Authorization: `Bearer ${accessToken}`
                    }
                });
                const user = await res.json();

                // Existing user profile rendering
                document.getElementById("userProfile").style.display = "flex";
                document.getElementById("userPic").src = user.picture || "https://www.gravatar.com/avatar?d=mp&s=200";
                document.getElementById("userName").innerText = user.name || "Unknown User";
                document.getElementById("userEmail").innerText = user.email || "";

                logChange("LOGIN", "", null, "");
            } catch (err) {
                console.error("Error fetching user profile:", err);
                toastr.error("Failed to load user profile. Please try re-authenticating.");
            }
        }

        function isUserAuthorized() {
            const AUTHORIZED_EMAILS = [
                "northmangamingcorporation@gmail.com",
                "it@northman.ph",
                "kristineamaeng31@gmail.com"
            ];

            const userEmail = document.getElementById("userEmail") ?.innerText ?.trim() || "";
            return AUTHORIZED_EMAILS.includes(userEmail);
        }


        // ------------------- Sheets Loader -------------------
        async function loadSheetsAfterAuth() {
            try {
                const sheets = await getSheetNames();
                renderMenu(sheets);

                if (sheets.includes("POS")) {
                    await loadSheet("POS");
                } else if (sheets.length > 0) {
                    await loadSheet(sheets[0]);
                }
            } catch (err) {
                console.error("Error loading sheets:", err);
                toastr.error("Failed to load sheets. Please try again.");
            }
        }

        function showLoader(show) {
            document.getElementById("loader").style.display = show ? "block" : "none";
        }

        // ---------------------------
        // Sheets API functions using OAuth2
        // ---------------------------
        


document.addEventListener("DOMContentLoaded", () => {
    // Main toggle function
    const toggleContainer = (element, src, label) => {
        const container = document.getElementById("reportCard");
        const tableCard = document.getElementById("tableCard");
        const iframe = document.getElementById("mainIframe");

        // Hide any other open section
        [...document.querySelectorAll(".toggleBtn")]
            .filter(el => el !== element)
            .forEach(otherEl => {
                if (otherEl.textContent.startsWith("‚ùå")) {
                    const otherLabel = otherEl.dataset.label;
                    otherEl.textContent = `üìä Show ${otherLabel}`;
                    toastr.info(`${otherLabel} hidden.`, "", { timeOut: 2000 });
                }
            });

        // Toggle current section
        if (!container.style.display || container.style.display === "none") {
            container.style.display = "block";
            tableCard.style.display = "none";
            iframe.src = src;
            element.textContent = `‚ùå Hide ${label}`;
            toastr.info(`${label} loaded.`, "", { timeOut: 2000 });
        } else {
            container.style.display = "none";
            tableCard.style.display = "block";
            element.textContent = `üìä Show ${label}`;
            toastr.info(`${label} hidden.`, "", { timeOut: 2000 });
        }
    };

    // List of toggle buttons
            const toggleElements = [
            { id: "linkAccomplishmentBtn", url: "accomplishmentReport.html", label: "Accomplishment Report" },
            { id: "linkReportBtn", url: "reports.html", label: "Report Analyzer" },
            { id: "linkITMonitoringBtn", url: "itMonitor/index.html", label: "IT Monitoring" },
            { id: "btnAccomplishmentBtn", url: "accomplishmentReport.html", label: "Accomplishment Report" },
            { id: "btnReportBtn", url: "reports.html", label: "Report Analyzer" },
            { id: "btnITMonitoringBtn", url: "itMonitor/index.html", label: "IT Monitoring" }
        ];


    // Attach click listeners
    toggleElements.forEach(item => {
        const el = document.getElementById(item.id);
        if (el) {
            el.classList.add("toggleBtn");
            el.dataset.label = item.label;
            el.addEventListener("click", () => toggleContainer(el, item.url, item.label));
        }
    });
});

        async function getSheetNames() {
            showLoader(true);

            try {
                const token = await ensureAccessToken(); // ‚úÖ always valid
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}?fields=sheets.properties.title`;

                let res = await fetch(url, {
                    headers: {
                        "Authorization": `Bearer ${token}`
                    }
                });

                if (res.status === 401) {
                    console.warn("Access token invalid, retrying with silent refresh...");
                    toastr.warning("Session expired. Attempting to refresh...", "", { timeOut: 3000 });
                    const refreshed = await attemptSilentAuth();
                    if (!refreshed) {
                        showAuthModal();
                        return [];
                    }
                    res = await fetch(url, {
                        headers: {
                            "Authorization": `Bearer ${accessToken}`
                        }
                    });
                }

                if (!res.ok) {
                    console.error(`Failed to fetch sheet names: ${res.status} ${res.statusText}`);
                    toastr.error("Failed to fetch sheet names. Please try again.");
                    return [];
                }

                const data = await res.json();
                if (!data.sheets) return [];
                return data.sheets.map(s => s.properties.title);
            } catch (err) {
                console.error("Error fetching sheet names:", err);
                toastr.error("Error fetching sheet names. Please check your connection.");
                return [];
            } finally {
                showLoader(false);
            }
        }

        // ---------------------------
        // Render menu (skip "Log")
        // ---------------------------
        async function renderMenu(sheets) {
            const menu = document.getElementById("menu");
            menu.innerHTML = "";

            sheets
                .filter(sheet => sheet !== "Log") // skip "Log"
                .filter(sheet => sheet !== "WebhookLogs") // skip "WebhookLogs"
                .forEach(sheet => {
                    const btn = document.createElement("button");
                    btn.textContent = sheet;
                    btn.onclick = () => loadSheet(sheet, btn);
                    menu.appendChild(btn);
                });
        }

        sheetDataWithFormat = []; // store formatting info
        // ---------------------------
        // Load sheet (optimized)
        // ---------------------------
        async function loadSheet(sheetName, button) {
            
             // Remove 'active' class from all buttons
            document.querySelectorAll("#menu button").forEach(b => b.classList.remove("active"));
            
            // Add 'active' class to the clicked button if button is defined
            if (button) {
                button.classList.add("active");
                
            }
            if (!sheetName) return;

            const container = document.getElementById("reportCard");
            const tableCard = document.getElementById("tableCard");
            container.style.display = "none"; // hide report when loading new sheet
            tableCard.style.display = "block"; // show table card   
        
            document.getElementById("sheetTitle").textContent = sheetName + " Data";
            sheetpage = sheetName;
            document.getElementById("tableContainer").innerHTML = "";
            showLoader(true);

            try {
                // ‚úÖ Load values only first (much faster)
                const urlValues = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(sheetName)}?majorDimension=ROWS`;
                const resValues = await fetch(urlValues, {
                    headers: {
                        "Authorization": `Bearer ${accessToken}`
                    }
                });
                const valuesData = await resValues.json();
                let values = valuesData.values || [];

                // Attach Google Sheets row index
                values = values.map((row, idx) => {
                    row._sheetRowIndex = idx + 1;
                    return row;
                });

                // Render table immediately (no styles yet)
                renderTable(values, sheetName);
                

                // ‚úÖ Load formatting in background (optional)
                const urlFormat = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}?ranges=${encodeURIComponent(sheetName)}&fields=sheets.data.rowData.values.effectiveFormat.backgroundColor&includeGridData=true`;
                const resFormat = await fetch(urlFormat, {
                    headers: {
                        "Authorization": `Bearer ${accessToken}`
                    }
                });
                const formatData = await resFormat.json();
                sheetDataWithFormat = (formatData.sheets ?.[0] ?.data ?.[0] ?.rowData || []).map(r => r.values || []);

                // Apply formatting asynchronously
                applyCellFormatting();
            } catch (err) {
                console.error("Error loading sheet:", err);
                toastr.error("Failed to load sheet data. Please try again.");   
            } finally {
                showLoader(false);
            }
        }

        // ---------------------------
        // Search filter
        // ---------------------------
        document.getElementById("searchInput").addEventListener("input", () => {
            const filter = document.getElementById("searchInput").value.trim().toLowerCase();
            const table = document.querySelector("#tableContainer table");
            if (!table) return;

            const rows = table.rows;
            const authorized = isUserAuthorized();

            for (let i = 1; i < rows.length; i++) { // skip header
                let match = false;

                // Check all cells except the last (Action)
                for (let j = 0; j < rows[i].cells.length - 1; j++) {
                    if (rows[i].cells[j].textContent.toLowerCase().includes(filter)) {
                        match = true;
                        break;
                    }
                }

                rows[i].style.display = match ? "" : "none";

                // Optionally, disable action buttons if unauthorized
                const actionBtns = rows[i].querySelectorAll(".action-buttons button");
                if (!authorized) {
                    actionBtns.forEach(btn => {
                        btn.disabled = true;
                        btn.title = "Not authorized";
                    });
                    const addBtn = document.getElementById("addBtn");
                    if (!addBtn) return;
                    addBtn.disabled = true;
                    addBtn.style.cursor = "not-allowed";
                    addBtn.style.opacity = "0.6"; // visually show it‚Äôs disabled
                } else {
                    actionBtns.forEach(btn => btn.disabled = false);
                }
            }
            toastr.info(`Filtered results for "${filter}".`, "", { timeOut: 2000 });

        });


        function renderTable(data, sheetName) {
            const container = document.getElementById("tableContainer");
            container.innerHTML = "";

            if (!data.length) {
                container.innerHTML = "<p>No data available</p>";
                return;
            }

            const headers = data[0] || [];
            const tbody = document.createElement("tbody");

            // Determine valid columns
            const validIndexes = headers.map((h, i) => i).filter(i =>
                data.some(row => row[i] && String(row[i]).trim() !== "")
            );

            // Identify status column
            const statusIndex = validIndexes.find(i =>
                (headers[i] || "").toLowerCase().includes("status")
            );

            // Count statuses
            let statusCounts = {};
            let uniqueStatuses = [];
            if (statusIndex !== undefined) {
                data.slice(1).forEach(row => {
                    const s = row[statusIndex] || "Unknown";
                    statusCounts[s] = (statusCounts[s] || 0) + 1;
                });
                uniqueStatuses = Object.keys(statusCounts);
            }

            // Identify operator column
            const operatorIndex = validIndexes.find(i =>
                (headers[i] || "").toLowerCase().includes("operator")
            );

            // Count operators
            let operatorCounts = {};
            let uniqueOperators = [];
            if (operatorIndex !== undefined) {
                data.slice(1).forEach(row => {
                    const op = row[operatorIndex] || "Unknown";
                    operatorCounts[op] = (operatorCounts[op] || 0) + 1;
                });
                uniqueOperators = Object.keys(operatorCounts);
            }

            // Render toolbar below title
            renderStatusToolbar(
                statusCounts,
                uniqueStatuses,
                statusIndex,
                headers,
                operatorCounts,
                uniqueOperators,
                operatorIndex
            );

            const authorized = isUserAuthorized();

            // Build table rows
            for (let rowIndex = 1; rowIndex < data.length; rowIndex++) {
                const row = data[rowIndex];
                const tr = document.createElement("tr");

                validIndexes.forEach(i => {
                    const td = document.createElement("td");
                    td.textContent = row[i] || "";
                    tr.appendChild(td);
                });

                // Action buttons
                const tdAction = document.createElement("td");
                if (authorized) {
                    tdAction.innerHTML = `
        <div class="action-buttons">
          <button onclick="editRow(${row._sheetRowIndex}, ${rowIndex}, '${sheetName}')">‚úèÔ∏è</button>
          <button onclick="deleteRowHandler(${row._sheetRowIndex}, '${sheetName}')">üóëÔ∏è</button>
        </div>`;
                } else {
                    tdAction.innerHTML = `
        <div class="action-buttons">
          <button disabled title="Not authorized">‚úèÔ∏è</button>
          <button disabled title="Not authorized">üóëÔ∏è</button>
        </div>`;
                    const addBtn = document.getElementById("addBtn");
                    if (!addBtn) return;
                    addBtn.disabled = true;
                    addBtn.style.cursor = "not-allowed";
                    addBtn.style.opacity = "0.6"; // visually show it‚Äôs disabled
                }

                tr.appendChild(tdAction);

                tr.dataset.key = row._sheetRowIndex;
                tbody.appendChild(tr);
            }

            // Build table header
            const headerHtml = validIndexes.map(i => `<th>${headers[i] || "Column " + (i+1)}</th>`).join("");

            // Build table
            container.innerHTML = `
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>${headerHtml}<th>Action</th></tr>
        </thead>
      </table>
    </div>
  `;
            document.querySelector("#tableContainer table").appendChild(tbody);

            // Apply formatting
            applyCellFormatting();
            toastr.info("Table loaded successfully.", "", { timeOut: 2000 });
        }

        // ---------------------------
        // Apply formatting (deferred)
        // ---------------------------
        function applyCellFormatting() {
            if (!sheetDataWithFormat) return;

            const rows = document.querySelectorAll("#tableContainer tbody tr");
            const cssRules = [];
            const usedClasses = new Set();

            rows.forEach((tr, rowIndex) => {
                const formatRow = sheetDataWithFormat[rowIndex + 1] || [];
                [...tr.children].forEach((td, colIndex) => {
                    const bg = formatRow[colIndex] ?.effectiveFormat ?.backgroundColor;
                    if (bg) {
                        const r = Math.round((bg.red ?? 0) * 255);
                        const g = Math.round((bg.green ?? 0) * 255);
                        const b = Math.round((bg.blue ?? 0) * 255);
                        const contrast = getContrastColor(r, g, b);
                        const cls = `cell-bg-${r}-${g}-${b}-${contrast}`;
                        td.classList.add(cls);

                        if (!usedClasses.has(cls)) {
                            cssRules.push(`.${cls}{background-color:rgb(${r},${g},${b});color:${contrast};}`);
                            usedClasses.add(cls);
                        }
                    }
                });
            });

            if (cssRules.length) {
                const styleEl = document.createElement("style");
                styleEl.textContent = cssRules.join("\n");
                document.head.appendChild(styleEl);
            }
        }

        // Utility for text contrast
        function getContrastColor(r, g, b) {
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            return brightness > 125 ? "black" : "white";
        }

        // ---------------------------
        // Status filter
        // ---------------------------
        function filterByStatus() {
            const filterValue = document.getElementById("statusFilter").value.toLowerCase();
            const table = document.querySelector("#tableContainer table");
            if (!table) return;
            const rows = table.querySelectorAll("tbody tr");
            rows.forEach(row => {
                const statusCell = Array.from(row.cells).find(cell => cell.textContent.toLowerCase() === filterValue);
                row.style.display = !filterValue || statusCell ? "" : "none";
            });
        }

        // ---------------------------
        // Add/Edit row modal
        // ---------------------------
        function openModal() {
            addSheetName = sheetpage;
            const table = document.querySelector("#tableContainer table");
            if (!table) return;
            const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.innerText).filter(h => h !== "Action");
            const rows = Array.from(table.querySelectorAll("tbody tr")).map(tr => Array.from(tr.cells).map(td => td.innerText));
            const form = document.getElementById("addRowForm");
            form.innerHTML = "";

            headers.forEach((header, colIndex) => {
                        const field = document.createElement("div");
                        field.classList.add("form-field");
                        let inputHTML = `<input type="text" name="${header}" placeholder="Enter ${header}">`;
                        const colValues = rows.map(r => r[colIndex]).filter(v => v && v.trim() !== "");
                        const freqMap = {};
                        colValues.forEach(v => freqMap[v] = (freqMap[v] || 0) + 1);
                        const sortedUnique = Object.entries(freqMap).sort((a, b) => b[1] - a[1]).map(([val]) => val);

                        if (/date/i.test(header)) {
                            inputHTML = `<input type="date" name="${header}">`;
                        } else if (/email/i.test(header)) {
                            inputHTML = `<input type="email" name="${header}" placeholder="name@example.com">`;
                        } else if (/status/i.test(header) || /operator code/i.test(header)) {
                            // Dropdown for Status and Operator Code
                            inputHTML = `<select name="${header}" style="width:100%;padding:6px;margin-bottom:10px;">
        <option value="">Select ${header}</option>
        ${sortedUnique.map(val => `<option value="${val}">${val}</option>`).join("")}
      </select>`;
    } else if(/amount|price|total/i.test(header)) {
      inputHTML = `<input type="number" step="0.01" name="${header}" placeholder="0.00">`;
    }

    field.innerHTML=`<label>${header}</label>${inputHTML}`;
    form.appendChild(field);
  });

  document.getElementById("addModal").style.display="flex";
    toastr.info("Fill out the form to add a new row.", "", { timeOut: 4000 });
}

function closeModal() { document.getElementById("addModal").style.display="none"; }

async function saveNewRow() {
  const form = document.getElementById("addRowForm");
  const inputs = form.querySelectorAll("input, select");
  const newValues = Array.from(inputs).map(input=>input.value.trim());
  const data = await appendRow(addSheetName, newValues);
  renderTable(data, addSheetName);
  closeModal();
    toastr.success("New row added successfully.", "", { timeOut: 2000 });
}

function editRow(primaryKey, tableRowIndex, sheetName) {
  currentEdit = { primaryKey, tableRowIndex, sheetName };

  const table = document.querySelector("#tableContainer table");
  const tbody = table.querySelector("tbody");
  const row = tbody.rows[tableRowIndex - 1]; // <-- map to tbody
  if (!row) {
    console.error("Row not found for editing:", tableRowIndex);
    toastr.error("Failed to enter edit mode. Please try again.");
    return;
  }

  const headers = Array.from(table.querySelectorAll("thead th")).map(th =>
    th.innerText.toLowerCase()
  );

  const statusColIndex = headers.findIndex(h => h.includes("status"));
  const operatorColIndex = headers.findIndex(h => h.includes("operator"));

  // collect unique statuses
  let uniqueStatuses = [];
  if (statusColIndex !== -1) {
    uniqueStatuses = [...new Set(
      Array.from(tbody.rows)
        .map(r => r.cells[statusColIndex]?.innerText.trim())
        .filter(v => v)
    )];
  }

  // collect unique operators
  let uniqueOperators = [];
  if (operatorColIndex !== -1) {
    uniqueOperators = [...new Set(
      Array.from(tbody.rows)
        .map(r => r.cells[operatorColIndex]?.innerText.trim())
        .filter(v => v)
    )];
  }

  for (let i = 0; i < row.cells.length - 1; i++) {
    const cell = row.cells[i];

    // status dropdown
    if (i === statusColIndex) {
      const currentValue = cell.innerText.trim();
      const optionsHTML = uniqueStatuses
        .map(
          s =>
            `<option value="${s}" ${s === currentValue ? "selected" : ""}>${s}</option>`
        )
        .join("");
      cell.innerHTML = `<select class="status-dropdown">${optionsHTML}</select>`;

    // operator dropdown
    } else if (i === operatorColIndex) {
      const currentValue = cell.innerText.trim();
      const optionsHTML = uniqueOperators
        .map(
          op =>
            `<option value="${op}" ${op === currentValue ? "selected" : ""}>${op}</option>`
        )
        .join("");
      cell.innerHTML = `<select class="operator-dropdown">${optionsHTML}</select>`;

    // other cells editable
    } else {
      cell.contentEditable = true;
      cell.addEventListener("paste", (e) => {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData("text");
        document.execCommand("insertText", false, text.trim());
      });
    }
  }

  // action buttons
  const actionCell = row.cells[row.cells.length - 1];
  actionCell.innerHTML = `
    <div class="action-buttons">
      <button onclick="saveRow()">üíæ</button>
      <button onclick="cancelEdit()">‚úñ</button>
    </div>
  `;
    toastr.info("You are now in edit mode. Make changes and click üíæ to save.", "", { timeOut: 4000 });
}

async function saveRow() {
  if (!currentEdit) return;

  const { primaryKey, tableRowIndex, sheetName } = currentEdit; // ‚úÖ extract properly
  const table = document.querySelector("#tableContainer table");
  const row = table.rows[tableRowIndex];
  const newValues = [];

  for (let i = 0; i < row.cells.length - 1; i++) {
    const select = row.cells[i].querySelector("select");
    const value = select ? select.value.trim() : row.cells[i].innerText.trim();
    newValues.push(value);

    row.cells[i].contentEditable = false;
    row.cells[i].innerText = value; // ‚úÖ write back final value
  }

  // ‚úÖ fast UI update done ‚Äî now sync in background
  updateRow(sheetName, primaryKey, newValues).then(async () => {
    // background re-sync with sheet
    const latestData = await getSheetData(sheetName);

    // find the row we just updated
    const updatedRow = latestData.find(r => r.primaryKey === primaryKey);
    if (updatedRow) {
      // only re-render if data differs
      for (let i = 0; i < newValues.length; i++) {
        if (row.cells[i].innerText.trim() !== updatedRow.values[i].trim()) {
          renderTable(sheetName, latestData);
          break;
        }
      }
    }
  }).catch(err => {
    console.error("Save failed:", err);
    toastr.error("Failed to save changes. Please try again.");
    // optionally show modal if auth expired
    showAuthModal();
  });

  // ‚úÖ restore action buttons immediately
  const actionCell = row.cells[row.cells.length - 1];
  actionCell.innerHTML = `<div class="action-buttons">
      <button onclick="editRow(${primaryKey}, ${tableRowIndex}, '${sheetName}')">‚úèÔ∏è</button>
      <button onclick="deleteRowHandler(${primaryKey}, '${sheetName}')">üóëÔ∏è</button>
    </div>`;
  toastr.success("Changes saved successfully.", "", { timeOut: 2000 });
  currentEdit = null;
}


async function cancelEdit() {
  showLoader(true);

  if (!currentEdit) return;
  const data = await getSheetData(currentEdit.sheetName); // ‚úÖ already fine
  renderTable(data, currentEdit.sheetName);
  currentEdit = null;
  showLoader(false);
  toastr.info("Edit cancelled.", "", { timeOut: 2000 });
}


async function deleteRowHandler(primaryKey, sheetName) {
  if (!confirm(`Are you sure you want to delete row ${primaryKey}?`)) return;
  showLoader(true);
  const data = await deleteRow(sheetName, primaryKey);
  renderTable(data, sheetName);
  toastr.success("Row deleted successfully.", "", { timeOut: 2000 });
  showLoader(false);
}
    </script>

</body>

</html>