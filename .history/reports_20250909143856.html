<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Excel Report Analyzer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="js/databaseConnect.js"></script>
    <script src="js/dataManipulate.js"></script>
    <script src="js/dataFiltering.js"></script>
    <script src="js/auth-modal.js" defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
/* ---------- Base Styles ---------- */
body {
  font-family: "Segoe UI", Roboto, Arial, sans-serif;
  padding: 20px;
  background: #f9fafb;
  color: #333;
  line-height: 1.5;
}

/* ---------- Table ---------- */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  background: #fff;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

th, td {
  padding: 10px 12px;
  text-align: left;
}

th {
  background: #f3f4f6;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 13px;
  letter-spacing: 0.5px;
  border-bottom: 2px solid #e5e7eb;
}

td {
  border-bottom: 1px solid #e5e7eb;
  font-size: 14px;
}

tr:hover td {
  background: #f9fafb;
}

/* ---------- Unrecorded Section ---------- */
.unrecorded {
  margin-top: 20px;
  padding: 12px 16px;
  border: 1px solid #fca5a5;
  background: #fee2e2;
  color: #b91c1c;
  font-weight: 600;
  border-radius: 6px;
}

.unrecorded ul {
  margin: 8px 0 0;
  padding-left: 20px;
}

.unrecorded li {
  margin: 4px 0;
}

/* ---------- Button ---------- */
button {
  display: inline-block;
  margin-top: 20px;
  padding: 10px 18px;
  background: #2563eb;
  border: none;
  border-radius: 6px;
  color: #fff;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.25s, transform 0.15s;
}

button:hover {
  background: #1d4ed8;
  transform: translateY(-1px);
}

button:active {
  background: #1e40af;
  transform: translateY(0);
}

/* ---------- Drop Zone ---------- */
#dropZone {
  margin-top: 20px;
  padding: 40px;
  border: 2px dashed #93c5fd;
  border-radius: 10px;
  background: #f9fafb;
  text-align: center;
  color: #555;
  font-size: 15px;
  cursor: pointer;
  transition: background 0.25s, border-color 0.25s;
}

#dropZone:hover {
  background: #f3f4f6;
  border-color: #3b82f6;
}

#dropZone.dragover {
  background: #e0f2fe;
  border-color: #2563eb;
  color: #1e40af;
}

#dropZone p {
  margin: 0;
}

#browseLink {
  color: #2563eb;
  font-weight: 600;
  cursor: pointer;
  text-decoration: underline;
}
.file-name {
  margin-top: 15px;
  font-weight: bold;
  color: #333;
}
  </style>
</head>
<body>
    
<div id="dropZone" class="drop-zone">
  <p>Drag & drop your Excel file here or <span id="browseLink">browse</span></p>
  <input type="file" id="fileInput" accept=".xlsx,.xls" hidden />
</div>

<!-- Will show after file is chosen -->
<div id="fileName" class="file-name" style="display:none;"></div>

  <div id="output"></div>
  <div id="unrecorded"></div>
  <button id="sendBtn" style="display:none;">Upload</button>

  <script>
let tableData = [];      // global
let unrecorded = [];     // global

const dropZone = document.getElementById("dropZone");
const fileInput = document.getElementById("fileInput");
const browseLink = document.getElementById("browseLink");
const fileNameDisplay = document.getElementById("fileName");

function showFileName(file) {
  dropZone.style.display = "none";
  fileNameDisplay.style.display = "block";
  fileNameDisplay.textContent = `üìÇ Selected file: ${file.name}`;
  handleFile(file);
}

// Browse link
browseLink.addEventListener("click", () => fileInput.click());
fileInput.addEventListener("change", (e) => {
  if (e.target.files.length > 0) showFileName(e.target.files[0]);
});

// Drag & drop
dropZone.addEventListener("dragover", (e) => { e.preventDefault(); dropZone.classList.add("dragover"); });
dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dragover"));
dropZone.addEventListener("drop", (e) => {
  e.preventDefault();
  dropZone.classList.remove("dragover");
  if (e.dataTransfer.files.length > 0) showFileName(e.dataTransfer.files[0]);
});

async function handleFile(file) {
  const reader = new FileReader();

  reader.onload = async (evt) => {
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, { type: "array" });

    // 1Ô∏è‚É£ Prompt user to choose a sheet if multiple sheets exist
    let chosenSheet = workbook.SheetNames[0];
    if (workbook.SheetNames.length > 1) {
      const sheetPrompt = "Select a sheet to process:\n" +
        workbook.SheetNames.map((s, i) => `${i + 1}. ${s}`).join("\n");
      const choice = prompt(sheetPrompt, "1");
      const index = parseInt(choice, 10) - 1;
      if (index >= 0 && index < workbook.SheetNames.length) {
        chosenSheet = workbook.SheetNames[index];
      }
    }

    // 2Ô∏è‚É£ Read selected sheet
    const sheet = workbook.Sheets[chosenSheet];
    tableData = XLSX.utils.sheet_to_json(sheet); // assign to global

    // 3Ô∏è‚É£ Fetch POS data
    const posData = await getSheetData("POS");
    const headers = posData[0];
    const posRows = posData.slice(1).map(r => ({
      operator: r[headers.indexOf("Operator")] || "",
      boothcode: r[headers.indexOf("Boothcode")] || ""
    }));

    // 4Ô∏è‚É£ Compare Excel vs POS
    unrecorded = tableData.filter(row =>
      !posRows.some(p =>
        p.operator.toLowerCase() === String(row.Operator).toLowerCase() &&
        p.boothcode.toLowerCase() === String(row.Outlet).toLowerCase()
      )
    );

    // 5Ô∏è‚É£ Render table and unrecorded list
    renderTable(tableData, unrecorded);

    // 6Ô∏è‚É£ Show Upload button
    document.getElementById("sendBtn").style.display = "block";
  };

  // Read the file
  reader.readAsArrayBuffer(file);
}


function renderTable(tableData, unrecorded) {
  if (tableData.length === 0) return;
  let html = "<table><thead><tr>";
  Object.keys(tableData[0]).forEach(col => html += `<th>${col}</th>`);
  html += "</tr></thead><tbody>";
  tableData.forEach(row => {
    html += "<tr>";
    Object.values(row).forEach(val => html += `<td>${val}</td>`);
    html += "</tr>";
  });
  html += "</tbody></table>";
  document.getElementById("output").innerHTML = html;

  if (unrecorded.length > 0) {
    let list = "<div class='unrecorded'>Unrecorded BoothCodes:<ul>";
    unrecorded.forEach(r => list += `<li>${r.Operator} - ${r.Outlet} (${r.Municipality})</li>`);
    list += "</ul></div>";
    document.getElementById("unrecorded").innerHTML = list;
  } else {
    document.getElementById("unrecorded").innerHTML = "";
  }
}

document.getElementById("sendBtn").addEventListener("click", async () => {
  if (!unrecorded || unrecorded.length === 0) {
    alert("‚ö†Ô∏è No unrecorded rows to append.");
    return;
  }

  try {
    for (const row of unrecorded) {
      await appendRow("UnrecordedBoothCodes", [
        new Date().toISOString(),
        "Unrecorded",
        row.Outlet || "",
        "",
        "",
        "",
        "",
        row.Municipality || "",
        "",
        row.Operator || "",
        "Pending"
      ]);
    }
    alert("‚úÖ Data successfully appended to Google Sheets!");
  } catch (err) {
    console.error("‚ùå Error appending rows:", err);
    alert("‚ùå Failed to append rows. Check console for details.");
  }
});
  </script>
</body>
</html>
