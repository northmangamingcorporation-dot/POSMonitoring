<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>IT Accomplishment Report</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
</head>
<body class="bg-gray-100 min-h-screen p-6">
<h1 class="text-2xl font-bold text-center text-gray-800 mb-6">IT Accomplishment Reports</h1>

<!-- Controls -->
<div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
  <!-- Add Button -->
  <button id="openModalBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition">
    âž• Add New Report
  </button>

  <!-- Search + Sort -->
  <div class="flex items-center gap-3">
    <input 
      type="text" 
      id="searchInput" 
      placeholder="Search reports..." 
      class="px-3 py-2 border rounded-lg text-sm w-64"
    >

    <select id="sortSelect" class="px-3 py-2 border rounded-lg text-sm">
      <option value="newest">Newest First</option>
      <option value="oldest">Oldest First</option>
    </select>
  </div>
</div>

  <!-- Reports Grid -->
  <div id="reportsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8"></div>

  <!-- Modal -->
  <div id="reportModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold text-gray-800">New Report</h2>
        <button id="closeModal" class="text-gray-600 hover:text-gray-800">&times;</button>
      </div>
      <form id="reportForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Date of Service</label>
          <input type="date" id="date" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Time of Service</label>
          <input type="time" id="time" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Service Type</label>
          <select id="serviceType" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500">
            <option value="">-- Select Service --</option>
            <option value="Cleaning Units">Cleaning Units</option>
            <option value="Repair & Maintenance">Repair & Maintenance</option>
            <option value="Software Installation">Software Installation</option>
            <option value="Network Support">Network Support</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Location</label>
          <input type="text" id="location" placeholder="Ex: Data Center - Building A" class="mt-1 w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Description of Work</label>
          <textarea id="description" rows="3" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Upload Proof (multiple images allowed)</label>

          <!-- Dropzone with built-in preview area -->
            <div id="dropzone" 
              class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:bg-gray-50">
              <p id="dropzoneText" class="text-gray-500">
                ðŸ“‚ Drag & Drop images here or click to select
              </p>
              <input type="file" id="images" multiple accept="image/*" class="hidden">

              <!-- Previews go here -->
              <div id="preview" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 mt-4" style="display: none;"></div>
            </div>
        </div>
        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Submit Report</button>
      </form>
    </div>
  </div>

  <script>
/* ---------- Safe element refs (uses existing vars if defined) ---------- */
const _form = (typeof form !== 'undefined') ? form : document.getElementById('reportForm');
const _fileInput = (typeof fileInput !== 'undefined') ? fileInput : document.getElementById('images');
const _preview = (typeof preview !== 'undefined') ? preview : document.getElementById('preview');
const _reportsGrid = (typeof reportsGrid !== 'undefined') ? reportsGrid : document.getElementById('reportsGrid');
const _modal = (typeof modal !== 'undefined') ? modal : document.getElementById('reportModal');

let uploadedImages = (typeof uploadedImages !== 'undefined') ? uploadedImages : [];
let uploadedImageFiles = (typeof uploadedImageFiles !== 'undefined') ? uploadedImageFiles : [];

/* ---------- helpers ---------- */
function dataURLtoFile(dataurl, filename = 'img.png') {
  const arr = dataurl.split(',');
  const mimeMatch = arr[0].match(/:(.*?);/);
  const mime = mimeMatch ? mimeMatch[1] : 'image/png';
  const bstr = atob(arr[1]);
  let n = bstr.length;
  const u8arr = new Uint8Array(n);
  while (n--) u8arr[n] = bstr.charCodeAt(n);
  return new File([u8arr], filename, { type: mime });
}

function updateFileInput() {
  const dt = new DataTransfer();
  uploadedImageFiles.forEach(f => dt.items.add(f));
  _fileInput.files = dt.files;
}

function toggleDropzoneText() {
  const txt = document.getElementById('dropzoneText');
  if (txt) txt.style.display = uploadedImages.length ? 'none' : 'block';
}

/* Render a single preview item inside the dropzone preview area */
function renderPreviewItem(fileSrc, fileObj) {
  const wrapper = document.createElement('div');
  wrapper.className = 'relative';
  wrapper.dataset.src = fileSrc;

  const img = document.createElement('img');
  img.src = fileSrc;
  img.className = 'w-full h-24 object-cover rounded border cursor-pointer';
  img.onclick = () => {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
    modal.innerHTML = `
      <div class="relative">
        <img src="${fileSrc}" class="max-h-[90vh] max-w-[90vw] rounded shadow-lg">
        <button class="absolute top-2 right-2 bg-white text-black rounded-full w-8 h-8 flex items-center justify-center">&times;</button>
      </div>
    `;
    modal.querySelector('button').onclick = () => modal.remove();
    modal.onclick = ev => { if (ev.target === modal) modal.remove(); };
    document.body.appendChild(modal);
  };

  const delBtn = document.createElement('button');
  delBtn.innerHTML = '&times;';
  delBtn.className = 'absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs hover:bg-red-600';
  delBtn.onclick = () => {
    wrapper.remove();
    uploadedImages = uploadedImages.filter(s => s !== fileSrc);
    uploadedImageFiles = uploadedImageFiles.filter(f => f !== fileObj);
    updateFileInput();
    toggleDropzoneText();
  };

  wrapper.appendChild(img);
  wrapper.appendChild(delBtn);
  _preview.appendChild(wrapper);
}

/* Clear dropzone previews and arrays */
function clearDropzone() {
  _preview.innerHTML = '';
  uploadedImages = [];
  uploadedImageFiles = [];
  updateFileInput();
  toggleDropzoneText();
}

/* Load an array of base64 image strings (from card.dataset.images) into the dropzone preview */
function loadCardImagesToDropzone(imagesArray = []) {
  clearDropzone();
  imagesArray.forEach((src, idx) => {
    // convert to File so input / submission remains consistent
    let fileObj;
    try {
      fileObj = dataURLtoFile(src, `image_${Date.now()}_${idx}.png`);
    } catch (err) {
      // fallback: create a Blob if conversion fails
      fileObj = new File([], `image_${Date.now()}_${idx}.png`);
    }
    uploadedImages.push(src);
    uploadedImageFiles.push(fileObj);
    renderPreviewItem(src, fileObj);
  });
  updateFileInput();
  toggleDropzoneText();
}

/* ---------- Attach card buttons (edit/delete/view) ---------- */
function attachCardEvents(card) {
  const editBtn = card.querySelector('.btn-edit');
  const deleteBtn = card.querySelector('.btn-delete');
  const viewBtn = card.querySelector('.view-details-btn');

  if (editBtn) {
    editBtn.onclick = () => editReport(card);
  }
  if (deleteBtn) {
    deleteBtn.onclick = () => {
      if (confirm('Delete this report?')) card.remove();
    };
  }
  if (viewBtn) {
    viewBtn.onclick = (e) => { e.preventDefault(); showCardDetails(card); };
  }
}

/* ---------- Edit: populate modal and load images ---------- */
function editReport(card) {
  // populate fields
  _form.date.value = card.dataset.date || '';
  _form.time.value = card.dataset.time || '';
  _form.serviceType.value = card.dataset.type || '';
  _form.location.value = card.dataset.location || '';
  _form.description.value = card.dataset.description || '';

  // load images stored on the card (if any)
  const imagesJson = card.dataset.images || '[]';
  let images = [];
  try { images = JSON.parse(imagesJson); } catch (e) { images = []; }
  loadCardImagesToDropzone(images);

  // mark editing and open modal
  _form.dataset.editingId = card.dataset.id;
  _modal.classList.remove('hidden', 'opacity-0'); // show modal (Tailwind)
}

/* ---------- Create/update card HTML ---------- */
function buildCardHtml({ date, time, serviceType, location, description, images }) {
  const cover = images && images.length ? images[0] : 'https://via.placeholder.com/400x200?text=No+Image';
  const thumbs = images && images.length ? images.slice(0, 3) : [];
  const moreCount = images && images.length > 3 ? images.length - 3 : 0;

  return `
    <div class="relative">
      <img src="${cover}" alt="Proof Image" class="w-full h-48 object-cover" />
      <div class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition">
        <div class="flex space-x-2">
          <button class="btn-edit w-8 h-8 bg-white rounded-full shadow flex items-center justify-center hover:bg-blue-600 hover:text-white">
            <i class="fas fa-edit text-xs"></i>
          </button>
          <button class="btn-delete w-8 h-8 bg-white rounded-full shadow flex items-center justify-center hover:bg-red-600 hover:text-white">
            <i class="fas fa-trash text-xs"></i>
          </button>
        </div>
      </div>
    </div>
    <div class="p-6">
      <div class="flex items-center justify-between mb-3">
        <span class="text-sm font-medium text-blue-600 bg-blue-50 px-2 py-1 rounded">
          <i class="fas fa-calendar mr-1"></i>${date}
        </span>
        <span class="text-xs text-gray-500">${time}</span>
      </div>
      <p class="text-sm text-gray-500 mb-2"><i class="fas fa-map-marker-alt mr-1"></i>${location || 'N/A'}</p>
      <h3 class="report-title font-semibold text-gray-800 mb-2">${serviceType}</h3>
      <p class="report-desc text-sm text-gray-600 mb-4">${description}</p>
      <div class="flex items-center justify-between">
        <div class="flex -space-x-2">
          ${thumbs.map(src => `<img src="${src}" class="w-8 h-8 rounded-full border-2 border-white object-cover" />`).join('')}
          ${moreCount ? `<div class="w-8 h-8 bg-gray-200 rounded-full border-2 border-white flex items-center justify-center"><span class="text-xs text-gray-600">+${moreCount}</span></div>` : ''}
        </div>
        <a href="#" class="view-details-btn text-blue-600 hover:text-blue-800 text-sm font-medium">View Details <i class="fas fa-arrow-right ml-1"></i></a>
      </div>
    </div>
  `;
}

/* ---------- Submit handler: creates or updates card (includes images) ---------- */
if (_form) {
  _form.addEventListener('submit', (e) => {
    e.preventDefault();

    const date = document.getElementById('date').value;
    const time = document.getElementById('time').value;
    const serviceType = document.getElementById('serviceType').value;
    const location = document.getElementById('location').value;
    const description = document.getElementById('description').value;
    const images = [...uploadedImages]; // base64 strings

    // if editing existing card
    const editingId = _form.dataset.editingId;
    if (editingId) {
      const card = document.querySelector(`.report-card[data-id="${editingId}"]`);
      if (card) {
        card.dataset.date = date;
        card.dataset.time = time;
        card.dataset.type = serviceType;
        card.dataset.location = location;
        card.dataset.description = description;
        card.dataset.images = JSON.stringify(images);

        card.innerHTML = buildCardHtml({ date, time, serviceType, location, description, images });
        attachCardEvents(card);
      }
      delete _form.dataset.editingId;
      _modal.classList.add('hidden');
      clearDropzone();
      _form.reset();
      return;
    }

    // create new card
    const card = document.createElement('div');
    card.className = 'report-card bg-white rounded-lg shadow hover:shadow-lg transition overflow-hidden group';
    card.dataset.id = Date.now();
    card.dataset.date = date;
    card.dataset.time = time;
    card.dataset.type = serviceType;
    card.dataset.location = location;
    card.dataset.description = description;
    card.dataset.images = JSON.stringify(images);

    card.innerHTML = buildCardHtml({ date, time, serviceType, location, description, images });

    _reportsGrid.prepend(card);
    attachCardEvents(card);

    // cleanup
    _modal.classList.add('hidden');
    _form.reset();
    clearDropzone();
  });
}

/* If you already have a file handler, keep it. Otherwise this is a simple handler to push files into preview (preserves existing API) */
if (_fileInput && _preview) {
  _fileInput.addEventListener('change', (e) => {
    Array.from(e.target.files).forEach(file => {
      if (!file.type.startsWith('image/')) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        const src = ev.target.result;
        uploadedImages.push(src);
        uploadedImageFiles.push(file);
        renderPreviewItem(src, file);
        updateFileInput();
        toggleDropzoneText();
      };
      reader.readAsDataURL(file);
    });
  });
}

/* Optional: delegated click handler for "View Details" that uses showCardDetails(card) if you defined it */
document.addEventListener('click', (ev) => {
  const a = ev.target.closest('a.view-details-btn');
  if (!a) return;
  ev.preventDefault();
  const card = a.closest('.report-card');
  if (card) showCardDetails ? showCardDetails(card) : alert(card.querySelector('.report-title')?.innerText || 'No title');
});



// ðŸ” SEARCH FUNCTION
document.getElementById("searchInput").addEventListener("input", function () {
  const query = this.value.toLowerCase();
  document.querySelectorAll("#reportsGrid .group").forEach(card => {
    const text = card.innerText.toLowerCase();
    card.style.display = text.includes(query) ? "" : "none";
  });
});

// ðŸ“‘ SORT FUNCTION
document.getElementById("sortSelect").addEventListener("change", function () {
  const sortType = this.value;
  const grid = document.getElementById("reportsGrid");
  const cards = Array.from(grid.children);

  cards.sort((a, b) => {
    const dateA = new Date(a.querySelector(".fa-calendar").parentElement.innerText.trim());
    const dateB = new Date(b.querySelector(".fa-calendar").parentElement.innerText.trim());
    return sortType === "newest" ? dateB - dateA : dateA - dateB;
  });

  // Re-append sorted cards
  cards.forEach(card => grid.appendChild(card));
});

// View Details Modal
document.addEventListener('DOMContentLoaded', () => {

  // show details modal for a card element â€” returns the created modal element
  function showCardDetails(card) {
    if (!card) { console.error('showCardDetails: no card passed'); return null; }

    // title (h3 or .title)
    const titleEl = card.querySelector('h3, .title, .report-title');
    const title = titleEl ? titleEl.innerText.trim() : '';

    // description => choose the longest <p>
    const pEls = Array.from(card.querySelectorAll('p'));
    const descEl = pEls.reduce((best, p) => {
      if (!best) return p;
      return (p.innerText.trim().length > best.innerText.trim().length) ? p : best;
    }, null);
    const description = descEl ? descEl.innerText.trim() : '';

    // date/time: search for date-like and time-like text among spans/time/small/divs
    let date = '', time = '';
    const candidates = Array.from(card.querySelectorAll('span, time, small, div'));
    for (const el of candidates) {
      const txt = (el.innerText || '').trim();
      if (!txt) continue;
      if (!date) {
        // accepts YYYY-MM-DD or M/D/YYYY or M/D/YY
        const dmatch = txt.match(/\b\d{4}-\d{2}-\d{2}\b|(\b\d{1,2}\/\d{1,2}\/\d{2,4}\b)/);
        if (dmatch) date = dmatch[0];
      }
      if (!time) {
        const tmatch = txt.match(/\b\d{1,2}:\d{2}\s?(AM|PM|am|pm)?\b/);
        if (tmatch) time = tmatch[0];
      }
      if (date && time) break;
    }

    // location: look for map marker icon inside the card and get its parent text
    let location = '';
    const locIcon = card.querySelector('.fa-map-marker-alt, .fa-map-marker');
    if (locIcon && locIcon.parentElement) location = locIcon.parentElement.innerText.trim();

    // images: collect all <img> srcs inside the card
    const images = Array.from(card.querySelectorAll('img'))
      .map(img => img.src)
      .filter(Boolean);

    // helper to escape HTML safely for injection
    function esc(s) {
      return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    // build modal
    const overlay = document.createElement('div');
    overlay.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
    overlay.style.padding = '1rem';

// modal content

    overlay.innerHTML = `
      <div class="bg-white rounded-lg shadow-lg w-full max-w-3xl p-6 relative overflow-auto" style="max-height:90vh;">
        <button type="button" class="close-modal" aria-label="Close" style="position:absolute;right:12px;top:8px;font-size:22px;border:none;background:none;cursor:pointer;">&times;</button>
        <h2 class="text-xl font-semibold mb-2">${esc(title)}</h2>
        <div class="text-sm text-gray-500 mb-3">
          ${ date ? `<span style="margin-right:0.75rem;"><i class="fas fa-calendar" style="margin-right:6px;"></i>${esc(date)}</span>` : '' }
          ${ time ? `<span><i class="far fa-clock" style="margin-right:6px;"></i>${esc(time)}</span>` : '' }
        </div>
        ${ location ? `<div class="text-sm text-gray-600 mb-4"><i class="fas fa-map-marker-alt" style="margin-right:6px;"></i>${esc(location)}</div>` : '' }
        <p class="text-gray-700 mb-4">${esc(description)}</p>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
          ${ images.length ? images.map(src => `<img src="${esc(src)}" class="w-full h-40 object-cover rounded">`).join('') : '<div class="text-sm text-gray-500">No images</div>' }
        </div>
      </div>
    `;

    // close handlers
    overlay.querySelector('.close-modal').addEventListener('click', () => overlay.remove());
    overlay.addEventListener('click', (ev) => { if (ev.target === overlay) overlay.remove(); });

    document.body.appendChild(overlay);
    return overlay;
  }

  // Delegated click handler â€” works even if you don't add a custom class
  document.addEventListener('click', (ev) => {
    // 1) prefer anchors with class or data attribute
    const anchor = ev.target.closest('a.view-details-btn, a[data-action="view-details"]') 
                 // 2) fallback: any <a> whose visible text starts with "View Details"
                 || (ev.target.closest('a') && ev.target.closest('a').textContent.trim().startsWith('View Details') ? ev.target.closest('a') : null);

    if (!anchor) return; // not a view-details click

    ev.preventDefault();

    // find the card ancestor (tries several common classes)
    const card = anchor.closest('.group, .report-card, .bg-surface, [data-report-id]');
    if (!card) {
      console.warn('View Details clicked but could not find a parent card element. Make sure the link is inside the card container.');
      return;
    }

    showCardDetails(card);
  });

});

  </script>
</body>
</html>
