<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <link rel="icon" type="image/jpeg" href="https://raw.githubusercontent.com/northmangamingcorporation-dot/POSMonitoring/main/cancellationlogo.jpg">
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: #f8f9fc;
      color: #333;
      display: flex;
      height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 250px;
      background: #1e293b;
      color: white;
      display: flex;
      flex-direction: column;
      padding: 20px;
    }
    .sidebar h2 {
      font-size: 18px;
      margin-bottom: 20px;
      text-align: center;
    }
    .menu {
      flex: 1;
    }
    .menu button {
      background: none;
      border: none;
      color: white;
      font-size: 16px;
      padding: 10px;
      text-align: left;
      width: 100%;
      border-radius: 8px;
      transition: 0.2s;
      cursor: pointer;
    }
    .menu button:hover {
      background: #334155;
    }

    /* Main Content */
    .main {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      position: relative;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

.table-wrapper {
  max-height: 700px; /* adjust as needed */
  overflow-y: auto;
  border: 1px solid #ccc;
}

.table-wrapper table {
  border-collapse: collapse;
  width: 100%;
}

.table-wrapper th, .table-wrapper td {
  padding: 8px;
  border: 1px solid #ccc;
  text-align: left;
}

.table-wrapper thead th {
  position: sticky;
  top: 0;
  background: #f5f5f5; /* header background */
  z-index: 2;
}


    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      font-size: 14px;
    }
    th {
      background: #f1f5f9;
    }

    /* Loader */
    .loader {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
    }
    .spinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #1e293b;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .status-info {
      margin-top: 8px;
      font-size: 14px;
      font-weight: 500;
    }
    .status-info .badge {
      background: #eee;
      border-radius: 6px;
      padding: 3px 8px;
      margin-right: 6px;
      display: inline-block;
      margin-bottom:10px;
    }

    .search-box {
      margin-bottom: 10px;
      width: 40%;
    }
    .search-box input {
      width: 40%;
      padding: 8px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .edit-btn {
      background: #2563eb;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .edit-btn:hover {
      background: #1e40af;
    }

    .editable-cell {
  background-color: #fff8dc; /* light yellow highlight */
  outline: none;
  border-bottom: 1px dashed #aaa;
}
.editable-cell:focus {
  background-color: #ffffcc;
}

    /* Highlight the full row */
.editing-row {
  background-color: #fff8c4 !important; /* light yellow */
  box-shadow: inset 0 0 6px rgba(0,0,0,0.2);
  transition: background-color 0.3s ease;
}

.action-buttons {
      display: flex;
      align-items: center;
      gap: 6px; /* spacing between buttons */
    }

    .btn-save, .btn-cancel {
      padding: 4px 8px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-save {
      background: #4caf50;
      color: white;
    }

    .btn-save:hover {
      background: #45a049;
    }

    .btn-cancel {
      background: #f44336;
      color: white;
    }

    .btn-cancel:hover {
      background: #e53935;
    }
.modal {
  display: none;
  position: fixed;
  inset: 0; /* full screen */
  z-index: 1000;
  background: rgba(0,0,0,0.5);
  margin-top:20px;
  display: flex;
  justify-content: center;
  align-items: center;

  /* keep modal centered even if page scrolls */
  overflow: hidden;
}

.modal-content {
  background: #fff;
  border-radius: 12px;
  width: 500px;
  max-width: 95%;
  max-height: 80vh;       /* don't exceed screen */
  overflow-y: auto;       /* scroll inside modal if content too long */
  padding: 20px 24px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.25);
  position: relative;
  animation: fadeInScale 0.25s ease;

  /* keep it centered */
  margin: auto;
}

.close-btn {
  position: absolute;
  top: 12px;
  right: 16px;
  font-size: 24px;
  font-weight: bold;
  color: #666;
  cursor: pointer;
  transition: color 0.2s;
}

.close-btn:hover {
  color: #000;
}

.modal h2 {
  margin-top: 0;
  font-size: 20px;
  margin-bottom: 16px;
  color: #222;
}

.modal-actions {
  margin-top: 20px;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  padding-top: 10px;
  border-top: 1px solid #eee;
}

.modal-actions button {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: background 0.2s ease;
}

.modal-actions button:first-child {
  background: #4caf50;
  color: #fff;
}

.modal-actions button:first-child:hover {
  background: #43a047;
}

.modal-actions button:last-child {
  background: #f44336;
  color: #fff;
}

.modal-actions button:last-child:hover {
  background: #e53935;
}

@keyframes fadeInScale {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}

#addRowForm {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.form-field {
  display: flex;
  flex-direction: column;
}

.form-field label {
  font-weight: 600;
  margin-bottom: 4px;
  color: #333;
}

.form-field input,
.form-field select {
  padding: 8px 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 14px;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.form-field input:focus,
.form-field select:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 2px rgba(0,123,255,0.2);
}

.status-dropdown {
  width: 100%;
  border: none;
  background: transparent;
  font: inherit;       /* use table font */
  padding: 0;
  margin: 0;
  outline: none;
  cursor: text;
  appearance: none;    /* hide default arrow */
  -webkit-appearance: none;
  -moz-appearance: none;
}

.status-dropdown:focus {
  background: #f0f8ff;  /* light highlight like editable cell */
}

.status-filter {
  margin-top: 10px;
  margin-bottom: 10px;
  font-size: 12px;
}

.status-filter select {
  padding: 4px 8px;
  border-radius: 6px;
}


  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body onload='loadSheet("POS")'>
  <div class="sidebar">
  <h2>STI Northman Gaming</h2>
  <div class="menu" id="menu"></div>
  
<!-- User Profile -->
<div id="userProfile" 
    style="display: none; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
           margin-top: 16px; padding: 12px; border-radius: 12px; max-width: 320px;
           color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.2); overflow: hidden;">

    <!-- Profile Picture -->
    <img id="userPic" src="" alt="Profile Picture" 
        style="width: 55px; height: 55px; border-radius: 50%; border: 3px solid white; flex-shrink: 0;">

    <div style="text-align: left; min-width: 0; flex: 1;">
    <div id="userName" 
    style="font-weight: bold; font-size: 16px; letter-spacing: 0.3px;
           line-height: 1.0; word-wrap: break-word; overflow-wrap: anywhere; margin-bottom: 4px;"></div>

    <div id="userEmail" 
        style="font-size: 13px; opacity: 0.9; font-style: italic;
               white-space: normal; word-wrap: break-word; overflow-wrap: anywhere;"></div>
  </div>
</div>

    <!-- Redirect button -->
    <button 
      style="margin-top: 16px; padding: 8px 16px; border: none; border-radius: 6px; background: #28a745; color: white; cursor: pointer;"
      onclick="window.location.href='https://networkmonitoring.vercel.app/'">
      Go to Network Monitoring
    </button>
  </div>

  <div class="main">
  <div class="loader" id="loader">
    <div class="spinner"></div>
  </div>
  <div class="card">
    <h2 id="sheetTitle">Select a Sheet</h2>
    <div class="search-box" style="display: flex; gap: 8px; margin-top: 10px;">
      <input type="text" id="searchInput" placeholder="Search..." style="flex: 1;">
      <button id="addBtn"
          style="padding: 8px 16px; border: none; border-radius: 6px; background: #007bff; color: white; cursor: pointer;"
          onclick="openModal()">
          ‚ûï ADD ENTRY
        </button>
    </div>
    <div id="tableContainer"></div>
  </div>
</div>

<!-- Modal -->
<div id="authModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
      background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
  <div style="background:white; padding:24px; border-radius:8px; max-width:400px; width:90%; text-align:center;">
    <h2>Sign In</h2>
    <p>You need to authorize Google Sheets access to continue.</p>
    <button id="modalAuthorizeBtn" style="padding:8px 16px; border:none; border-radius:6px; 
            background:#007bff; color:white; cursor:pointer;">
      Authorize
    </button>
  </div>
</div>

<!-- Add Row Modal -->
<div id="addModal" class="modal"style="display:none;">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal()">&times;</span>
    <h2>Add New Row</h2>
    <form id="addRowForm"></form>
    <div class="modal-actions">
      <button type="button" onclick="saveNewRow()">üíæ Save</button>
      <button type="button" onclick="closeModal()">‚ùå Cancel</button>
    </div>
  </div>
</div>

<script>
// ------------------- Auth Config -------------------
const CLIENT_ID = "900901251874-tlbsv8ph1rfcmtnk77pqm5dkqptip0ic.apps.googleusercontent.com";
const SPREADSHEET_ID = "1VWPTrBlRIWOBHHIFttTUZH5mDnbKvieyR_gZOHsrNQQ";
const SCOPES = "https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email";

let tokenClient;
let accessToken = null;
let tokenExpiry = 0;
let checkInterval = null;

let sheetpage = "";
let addSheetName = "";
let sheetDataCache = {};
let currentEdit = null;

// ------------------- Init -------------------
window.onload = () => {
  initGIS();
};

document.getElementById("modalAuthorizeBtn").addEventListener("click", () => {
  tokenClient.requestAccessToken({ prompt: "consent" });
});

// ------------------- GIS Setup -------------------
function initGIS() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: (tokenResponse) => {
      handleNewToken(tokenResponse);
    },
  });

  // Try to reuse token from sessionStorage
  const savedToken = sessionStorage.getItem("gsheets_access_token");
  const savedExpiry = sessionStorage.getItem("gsheets_token_expiry");

  if (savedToken && savedExpiry && Date.now() < parseInt(savedExpiry, 10)) {
    accessToken = savedToken;
    tokenExpiry = parseInt(savedExpiry, 10);
    hideAuthModal();
    loadUserProfile();
    loadSheetsAfterAuth();
    checkInterval = setInterval(checkTokenValidity, 30 * 1000);
  } else {
    showAuthModal();
  }
}

// ------------------- Handle new tokens -------------------
function handleNewToken(tokenResponse) {
  if (tokenResponse.error) {
    console.error("Auth error:", tokenResponse);
    showAuthModal();
    return;
  }

  accessToken = tokenResponse.access_token;
  tokenExpiry = Date.now() + (tokenResponse.expires_in * 1000);

  sessionStorage.setItem("gsheets_access_token", accessToken);
  sessionStorage.setItem("gsheets_token_expiry", tokenExpiry);

  hideAuthModal();
  loadUserProfile();
  loadSheetsAfterAuth();
  logChange("handleNewToken", "accessToken", accessToken + "-" + tokenExpiry, "");
  if (checkInterval) clearInterval(checkInterval);
  checkInterval = setInterval(checkTokenValidity, 30 * 1000);
}

// ------------------- Token Refresh -------------------
function checkTokenValidity() {
  if (!accessToken || Date.now() >= tokenExpiry - 5000) {
    console.warn("Token expired or near expiry, refreshing...");
    tokenClient.requestAccessToken({ prompt: "" }); // silent refresh
  }
}

// ------------------- Auth Modal Helpers -------------------
function showAuthModal() {
  document.getElementById("authModal").style.display = "flex";
}

function hideAuthModal() {
  document.getElementById("authModal").style.display = "none";
}

// ------------------- Token Utils -------------------
function isTokenExpired() {
  return !accessToken || Date.now() >= tokenExpiry - 5000;
}

async function ensureAccessToken() {
  if (!accessToken) {
    console.log("No access token, showing login modal...");
    showAuthModal();
    throw new Error("No access token");
  }

  if (isTokenExpired()) {
    console.log("Token expired, refreshing silently...");
    tokenClient.requestAccessToken({ prompt: "" });
    await new Promise((resolve) => setTimeout(resolve, 1000)); // small wait
    if (isTokenExpired()) {
      console.log("Silent refresh failed, showing login modal...");
      showAuthModal();
      throw new Error("Silent refresh failed");
    }
  }

  return accessToken;
}

// ------------------- User Profile -------------------
async function loadUserProfile() {
  try {
    const res = await fetch("https://www.googleapis.com/oauth2/v3/userinfo", {
      headers: { Authorization: `Bearer ${accessToken}` }
    });
    const user = await res.json();

    document.getElementById("userProfile").style.display = "flex";
    document.getElementById("userPic").src = user.picture || "https://www.gravatar.com/avatar?d=mp&s=200";
    document.getElementById("userName").innerText = user.name || "Unknown User";
    document.getElementById("userEmail").innerText = user.email || "";
    
  } catch (err) {
    console.error("Error fetching user profile:", err);
  }
}

function isUserAuthorized() {
  const AUTHORIZED_EMAILS = [
    "northmangamingcorporation@gmail.com",
    "it@northman.ph",
    "kristineamaeng31@gmail.com"
  ];

  const userEmail = document.getElementById("userEmail")?.innerText?.trim() || "";
  return AUTHORIZED_EMAILS.includes(userEmail);
}


// ------------------- Sheets Loader -------------------
async function loadSheetsAfterAuth() {
  try {
    const sheets = await getSheetNames();
    renderMenu(sheets);

    if (sheets.includes("POS")) {
      await loadSheet("POS");
    } else if (sheets.length > 0) {
      await loadSheet(sheets[0]);
    }
  } catch (err) {
    console.error("Error loading sheets:", err);
  }
}
function showLoader(show) {
  document.getElementById("loader").style.display = show ? "block" : "none";
}

// ---------------------------
// Sheets API functions using OAuth2
// ---------------------------
async function getSheetData(sheetName) {
  showLoader(true);
  console.log(`Fetching data for sheet: ${sheetName}`);

  try {
    const token = await ensureAccessToken(); // ‚úÖ always valid
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(sheetName)}`;

    let res = await fetch(url, { headers: { "Authorization": `Bearer ${token}` } });

    // If unauthorized, try silent refresh once more
    if (res.status === 401) {
      console.warn("Access token invalid, retrying with silent refresh...");
      const refreshed = await attemptSilentAuth();
      if (!refreshed) {
        showAuthModal();
        return [];
      }
      res = await fetch(url, { headers: { "Authorization": `Bearer ${accessToken}` } });
    }

    if (!res.ok) {
      console.error(`Failed to fetch sheet data: ${res.status} ${res.statusText}`);
      return [];
    }

    const data = await res.json();
    console.log("Sheet data received:", data);
    sheetDataCache[sheetName] = data.values || [];
    return sheetDataCache[sheetName];
  } catch (err) {
    console.error("Error fetching sheet data:", err);
    return [];
  } finally {
    showLoader(false);
  }
}

async function getSheetNames() {
  showLoader(true);
  console.log("Fetching sheet names...");

  try {
    const token = await ensureAccessToken(); // ‚úÖ always valid
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}?fields=sheets.properties.title`;

    let res = await fetch(url, { headers: { "Authorization": `Bearer ${token}` } });

    if (res.status === 401) {
      console.warn("Access token invalid, retrying with silent refresh...");
      const refreshed = await attemptSilentAuth();
      if (!refreshed) {
        showAuthModal();
        return [];
      }
      res = await fetch(url, { headers: { "Authorization": `Bearer ${accessToken}` } });
    }

    if (!res.ok) {
      console.error(`Failed to fetch sheet names: ${res.status} ${res.statusText}`);
      return [];
    }

    const data = await res.json();
    console.log("Sheet names received:", data);
    if (!data.sheets) return [];
    return data.sheets.map(s => s.properties.title);
  } catch (err) {
    console.error("Error fetching sheet names:", err);
    return [];
  } finally {
    showLoader(false);
  }
}



// ---------------------------
// Append row
// ---------------------------
async function appendRow(sheetName, values) {
  try {
    if (!accessToken) throw new Error("No access token");

    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(sheetName)}:append?valueInputOption=RAW`;

    const res = await fetch(url, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${accessToken}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ values: [values] })
    });

    if (!res.ok) throw new Error(`Append failed: ${res.status} ${res.statusText}`);

    await logChange("ADD", sheetName, values); // Log the addition
    return getSheetData(sheetName);
  } catch (err) {
    console.error("Error appending row:", err);
  }
}

// ---------------------------
// Update row
// ---------------------------
async function updateRow(sheetName, rowIndex, values) {
  try {
    if (!accessToken) throw new Error("No access token");

    const range = `${sheetName}!A${rowIndex}`;
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(range)}?valueInputOption=RAW`;

    const res = await fetch(url, {
      method: "PUT",
      headers: {
        "Authorization": `Bearer ${accessToken}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ values: [values] })
    });

    if (!res.ok) throw new Error(`Update failed: ${res.status} ${res.statusText}`);

    await logChange("EDIT", sheetName, values, rowIndex); // Log the edit
    return getSheetData(sheetName);
  } catch (err) {
    console.error("Error updating row:", err);
  }
}

// ---------------------------
// Delete row
// ---------------------------
async function deleteRow(sheetName, rowIndex) {
  try {
    if (!accessToken) throw new Error("No access token");

    // Get sheet ID
    const sheetInfoUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}?fields=sheets.properties`;
    const sheetInfoRes = await fetch(sheetInfoUrl, {
      headers: { "Authorization": `Bearer ${accessToken}` }
    });
    const sheetInfo = await sheetInfoRes.json();
    const sheet = sheetInfo.sheets.find(s => s.properties.title === sheetName);
    if (!sheet) throw new Error("Sheet not found");
    const sheetId = sheet.properties.sheetId;

    // Delete the row
    const batchUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}:batchUpdate`;
    const batchRes = await fetch(batchUrl, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${accessToken}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        requests: [{
          deleteDimension: {
            range: {
              sheetId: sheetId,
              dimension: "ROWS",
              startIndex: rowIndex - 1,
              endIndex: rowIndex
            }
          }
        }]
      })
    });

    if (!batchRes.ok) throw new Error(`Delete failed: ${batchRes.status} ${batchRes.statusText}`);

    await logChange("DELETE", sheetName, null, rowIndex); // Log the deletion
    return getSheetData(sheetName);
  } catch (err) {
    console.error("Error deleting row:", err);
  }
}

// ---------------------------
// Log changes with location, device info, username & email
// ---------------------------
async function logChange(action, sheetName, rowData, rowIndex) {
  try {
    if (!accessToken) throw new Error("No access token");

    const timestamp = new Date().toISOString();

    // Get username and email from your page (or replace with auth info)
    const userName = document.getElementById("userName")?.innerText || "Unknown User";
    const userEmail = document.getElementById("userEmail")?.innerText || "Unknown Email";
    const user = `${userName} (${userEmail})`;

    const deviceInfo = navigator.userAgent || "Unknown Device";

    const dataString = JSON.stringify(rowData);

    // Add userName and userEmail separately in the log for clarity
    const logValues = [[
      timestamp,
      userName,
      userEmail,
      deviceInfo,
      action,
      sheetName,
      rowIndex ?? "",
      dataString
    ]];

    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Log:append?valueInputOption=RAW`;

    const res = await fetch(url, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${accessToken}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ values: logValues })
    });

    if (!res.ok) console.warn("Failed to log change:", res.status, res.statusText);

  } catch (err) {
    console.error("Error logging change:", err);
  }
}

// ---------------------------
// Render menu (skip "Log")
// ---------------------------
async function renderMenu(sheets) {
  const menu = document.getElementById("menu");
  menu.innerHTML = "";

  sheets
    .filter(sheet => sheet !== "Log") // skip "Log"
    .forEach(sheet => {
      const btn = document.createElement("button");
      btn.textContent = sheet;
      btn.onclick = () => loadSheet(sheet);
      menu.appendChild(btn);
    });
}

sheetDataWithFormat = []; // store formatting info
// ---------------------------
// Load sheet (optimized)
// ---------------------------
async function loadSheet(sheetName) {
  document.getElementById("sheetTitle").textContent = sheetName + " Data";
  sheetpage = sheetName;
  document.getElementById("tableContainer").innerHTML = "";
  showLoader(true);

  try {
    // ‚úÖ Load values only first (much faster)
    const urlValues = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(sheetName)}?majorDimension=ROWS`;
    const resValues = await fetch(urlValues, {
      headers: { "Authorization": `Bearer ${accessToken}` }
    });
    const valuesData = await resValues.json();
    let values = valuesData.values || [];

    // Attach Google Sheets row index
    values = values.map((row, idx) => {
      row._sheetRowIndex = idx + 1;
      return row;
    });

    // Render table immediately (no styles yet)
    renderTable(values, sheetName);

    // ‚úÖ Load formatting in background (optional)
    const urlFormat = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}?ranges=${encodeURIComponent(sheetName)}&fields=sheets.data.rowData.values.effectiveFormat.backgroundColor&includeGridData=true`;
    const resFormat = await fetch(urlFormat, {
      headers: { "Authorization": `Bearer ${accessToken}` }
    });
    const formatData = await resFormat.json();
    sheetDataWithFormat = (formatData.sheets?.[0]?.data?.[0]?.rowData || []).map(r => r.values || []);

    // Apply formatting asynchronously
    applyCellFormatting();
  } catch (err) {
    console.error("Error loading sheet:", err);
  } finally {
    showLoader(false);
  }
}

function renderTable(data, sheetName) {
  const container = document.getElementById("tableContainer");
  container.innerHTML = "";

  if (!data.length) {
    container.innerHTML = "<p>No data available</p>";
    return;
  }

  const headers = data[0] || [];
  const tbody = document.createElement("tbody");

  // Determine valid columns
  const validIndexes = headers.map((h, i) => i).filter(i =>
    data.some(row => row[i] && String(row[i]).trim() !== "")
  );

  // Identify status column
  const statusIndex = validIndexes.find(i =>
    (headers[i] || "").toLowerCase().includes("status")
  );

  // Count statuses
  let statusCounts = {};
  let uniqueStatuses = [];
  if (statusIndex !== undefined) {
    data.slice(1).forEach(row => {
      const s = row[statusIndex] || "Unknown";
      statusCounts[s] = (statusCounts[s] || 0) + 1;
    });
    uniqueStatuses = Object.keys(statusCounts);
  }

  // Render toolbar below title
  renderStatusToolbar(statusCounts, uniqueStatuses, statusIndex);

  const authorized = isUserAuthorized();

  // Build table rows
  for (let rowIndex = 1; rowIndex < data.length; rowIndex++) {
    const row = data[rowIndex];
    const tr = document.createElement("tr");

    validIndexes.forEach(i => {
      const td = document.createElement("td");
      td.textContent = row[i] || "";
      tr.appendChild(td);
    });

    // Action buttons
    const tdAction = document.createElement("td");
    if (authorized) {
      tdAction.innerHTML = `
        <div class="action-buttons">
          <button onclick="editRow(${row._sheetRowIndex}, ${rowIndex}, '${sheetName}')">‚úèÔ∏è</button>
          <button onclick="deleteRowHandler(${row._sheetRowIndex}, '${sheetName}')">üóëÔ∏è</button>
        </div>`;
    } else {
      tdAction.innerHTML = `
        <div class="action-buttons">
          <button disabled title="Not authorized">‚úèÔ∏è</button>
          <button disabled title="Not authorized">üóëÔ∏è</button>
        </div>`;
      const addBtn = document.getElementById("addBtn");
      if (!addBtn) return;
      addBtn.disabled = true;
      addBtn.style.cursor = "not-allowed";
      addBtn.style.opacity = "0.6"; // visually show it‚Äôs disabled
    }

    tr.appendChild(tdAction);

    tr.dataset.key = row._sheetRowIndex;
    tbody.appendChild(tr);
  }

  // Build table header
  const headerHtml = validIndexes.map(i => `<th>${headers[i] || "Column " + (i+1)}</th>`).join("");

  // Build table
  container.innerHTML = `
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>${headerHtml}<th>Action</th></tr>
        </thead>
      </table>
    </div>
  `;
  document.querySelector("#tableContainer table").appendChild(tbody);

  // Apply formatting
  applyCellFormatting();
}

// ---------------------------
// Apply formatting (deferred)
// ---------------------------
function applyCellFormatting() {
  if (!sheetDataWithFormat) return;

  const rows = document.querySelectorAll("#tableContainer tbody tr");
  const cssRules = [];
  const usedClasses = new Set();

  rows.forEach((tr, rowIndex) => {
    const formatRow = sheetDataWithFormat[rowIndex + 1] || [];
    [...tr.children].forEach((td, colIndex) => {
      const bg = formatRow[colIndex]?.effectiveFormat?.backgroundColor;
      if (bg) {
        const r = Math.round((bg.red ?? 0) * 255);
        const g = Math.round((bg.green ?? 0) * 255);
        const b = Math.round((bg.blue ?? 0) * 255);
        const contrast = getContrastColor(r, g, b);
        const cls = `cell-bg-${r}-${g}-${b}-${contrast}`;
        td.classList.add(cls);

        if (!usedClasses.has(cls)) {
          cssRules.push(`.${cls}{background-color:rgb(${r},${g},${b});color:${contrast};}`);
          usedClasses.add(cls);
        }
      }
    });
  });

  if (cssRules.length) {
    const styleEl = document.createElement("style");
    styleEl.textContent = cssRules.join("\n");
    document.head.appendChild(styleEl);
  }
}

// Utility for text contrast
function getContrastColor(r, g, b) {
  const brightness = (r * 299 + g * 587 + b * 114) / 1000;
  return brightness > 125 ? "black" : "white";
}

// ---------------------------
// Status filter
// ---------------------------
function filterByStatus() {
  const filterValue = document.getElementById("statusFilter").value.toLowerCase();
  const table = document.querySelector("#tableContainer table");
  if (!table) return;
  const rows = table.querySelectorAll("tbody tr");
  rows.forEach(row => {
    const statusCell = Array.from(row.cells).find(cell => cell.textContent.toLowerCase() === filterValue);
    row.style.display = !filterValue || statusCell ? "" : "none";
  });
}

function renderStatusToolbar(statusCounts, uniqueStatuses, statusIndex, headers) {
  const sheetTitleEl = document.getElementById("sheetTitle");

  // Remove previous toolbar
  const existingToolbar = document.getElementById("statusToolbar");
  if (existingToolbar) existingToolbar.remove();

  const toolbar = document.createElement("div");
  toolbar.id = "statusToolbar";
  toolbar.style.display = "flex";
  toolbar.style.flexDirection = "column";
  toolbar.style.gap = "6px";
  toolbar.style.marginTop = "8px";

  // --- Status badges row ---
  const badgesRow = document.createElement("div");
  badgesRow.className = "status-info"; // your CSS class
  Object.entries(statusCounts).forEach(([s, c]) => {
    const badge = document.createElement("span");
    badge.className = "badge"; // uses your CSS
    badge.textContent = `${s}: ${c}`;
    badgesRow.appendChild(badge);
  });
  toolbar.appendChild(badgesRow);

  // --- Filter dropdown row ---
  if (statusIndex !== undefined && uniqueStatuses.length > 0) {
    const filterRow = document.createElement("div");
    filterRow.style.display = "flex";
    filterRow.style.alignItems = "center";
    filterRow.style.gap = "8px";

    const label = document.createElement("span");
    label.textContent = "Filter by Status:";
    label.style.fontWeight = "bold";
    filterRow.appendChild(label);

    const select = document.createElement("select");
    select.id = "statusFilter";
    select.onchange = () => {
      filterByStatus();
    };

    const allOption = document.createElement("option");
    allOption.value = "";
    allOption.textContent = "All";
    select.appendChild(allOption);

    uniqueStatuses.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      select.appendChild(opt);
    });

    filterRow.appendChild(select);

    const filteredByLabel = document.createElement("span");
    filteredByLabel.id = "filteredByLabel";
    filteredByLabel.style.fontWeight = "bold";
    filterRow.appendChild(filteredByLabel);

    toolbar.appendChild(filterRow);
  }

  // --- Sorting dropdown row ---
  if (headers && headers.length > 0) {
    const sortRow = document.createElement("div");
    sortRow.style.display = "flex";
    sortRow.style.alignItems = "center";
    sortRow.style.gap = "8px";

    const sortLabel = document.createElement("span");
    sortLabel.textContent = "Sort by:";
    sortLabel.style.fontWeight = "bold";
    sortRow.appendChild(sortLabel);

    const sortSelect = document.createElement("select");
    sortSelect.id = "sortSelect";
    sortSelect.className = "status-filter";
    sortSelect.onchange = () => sortTableByColumn(sortSelect.value);

    const sortDefault = document.createElement("option");
    sortDefault.value = "";
    sortDefault.textContent = "None";
    sortSelect.appendChild(sortDefault);

    headers.forEach((h, idx) => {
      const opt = document.createElement("option");
      opt.value = idx;
      opt.textContent = h || `Column ${idx + 1}`;
      sortSelect.appendChild(opt);
    });

    sortRow.appendChild(sortSelect);
    toolbar.appendChild(sortRow);
  }

  // Insert toolbar after the title
  sheetTitleEl.insertAdjacentElement("afterend", toolbar);
}


// ---------------------------
// Green Device ID filter
// ---------------------------
function filterByGreenDeviceID() {
  const table = document.querySelector("#tableContainer table");
  if (!table) return;

  // Assuming Device ID column is already identified in the header
  const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.innerText.toLowerCase());
  const deviceColIndex = headers.findIndex(h => h.includes("device id"));
  if (deviceColIndex === -1) return;

  const rows = table.querySelectorAll("tbody tr");
  rows.forEach(row => {
    const cell = row.cells[deviceColIndex];
    if (!cell) return;

    // Check if cell has dark green background (inline style)
    const bgColor = window.getComputedStyle(cell).backgroundColor;
    // Approximate dark green: rgb(0, 128, 0)
    const isGreen = bgColor === "rgb(0, 128, 0)" || bgColor === "rgb(0, 100, 0)";
    
    row.style.display = isGreen ? "" : "none";
  });
}

// ---------------------------
// Search filter
// ---------------------------
document.getElementById("searchInput").addEventListener("input", () => {
  const filter = document.getElementById("searchInput").value.trim().toLowerCase();
  const table = document.querySelector("#tableContainer table");
  if (!table) return;

  const rows = table.rows;
  const authorized = isUserAuthorized();

  for (let i = 1; i < rows.length; i++) { // skip header
    let match = false;

    // Check all cells except the last (Action)
    for (let j = 0; j < rows[i].cells.length - 1; j++) {
      if (rows[i].cells[j].textContent.toLowerCase().includes(filter)) {
        match = true;
        break;
      }
    }

    rows[i].style.display = match ? "" : "none";

    // Optionally, disable action buttons if unauthorized
    const actionBtns = rows[i].querySelectorAll(".action-buttons button");
    if (!authorized) {
      actionBtns.forEach(btn => {
        btn.disabled = true;
        btn.title = "Not authorized";
      });
      const addBtn = document.getElementById("addBtn");
      if (!addBtn) return;
      addBtn.disabled = true;
      addBtn.style.cursor = "not-allowed";
      addBtn.style.opacity = "0.6"; // visually show it‚Äôs disabled
    } else {
      actionBtns.forEach(btn => btn.disabled = false);
    }
  }
});


// ---------------------------
// Add/Edit row modal
// ---------------------------
function openModal() {
  addSheetName = sheetpage;
  const table = document.querySelector("#tableContainer table");
  if (!table) return;
  const headers = Array.from(table.querySelectorAll("thead th")).map(th=>th.innerText).filter(h=>h!=="Action");
  const rows = Array.from(table.querySelectorAll("tbody tr")).map(tr=>Array.from(tr.cells).map(td=>td.innerText));
  const form = document.getElementById("addRowForm");
  form.innerHTML = "";

  headers.forEach((header,colIndex)=>{
    const field = document.createElement("div"); field.classList.add("form-field");
    let inputHTML=`<input type="text" name="${header}" placeholder="Enter ${header}">`;
    const colValues = rows.map(r=>r[colIndex]).filter(v=>v&&v.trim()!=="");
    const freqMap={}; colValues.forEach(v=>freqMap[v]=(freqMap[v]||0)+1);
    const sortedUnique = Object.entries(freqMap).sort((a,b)=>b[1]-a[1]).map(([val])=>val);

    if(/date/i.test(header)) {
      inputHTML = `<input type="date" name="${header}">`;
    } else if(/email/i.test(header)) {
      inputHTML = `<input type="email" name="${header}" placeholder="name@example.com">`;
    } else if(/status/i.test(header) || /operator code/i.test(header)) {
      // Dropdown for Status and Operator Code
      inputHTML = `<select name="${header}" style="width:100%;padding:6px;margin-bottom:10px;">
        <option value="">Select ${header}</option>
        ${sortedUnique.map(val => `<option value="${val}">${val}</option>`).join("")}
      </select>`;
    } else if(/amount|price|total/i.test(header)) {
      inputHTML = `<input type="number" step="0.01" name="${header}" placeholder="0.00">`;
    }

    field.innerHTML=`<label>${header}</label>${inputHTML}`;
    form.appendChild(field);
  });

  document.getElementById("addModal").style.display="flex";
}

function closeModal() { document.getElementById("addModal").style.display="none"; }

async function saveNewRow() {
  const form = document.getElementById("addRowForm");
  const inputs = form.querySelectorAll("input, select");
  const newValues = Array.from(inputs).map(input=>input.value.trim());
  const data = await appendRow(addSheetName, newValues);
  renderTable(data, addSheetName);
  closeModal();
}

function editRow(primaryKey, tableRowIndex, sheetName) {
  currentEdit = { primaryKey, tableRowIndex, sheetName };

  const table = document.querySelector("#tableContainer table");
  const tbody = table.querySelector("tbody");
  const row = tbody.rows[tableRowIndex - 1]; // <-- map to tbody

  if (!row) {
    console.error("Row not found for editing:", tableRowIndex);
    return;
  }

  const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.innerText.toLowerCase());
  const statusColIndex = headers.findIndex(h => h.includes("status"));

  let uniqueStatuses = [];
  if (statusColIndex !== -1) {
    uniqueStatuses = [...new Set(Array.from(tbody.rows)
      .map(r => r.cells[statusColIndex]?.innerText.trim())
      .filter(v => v))];
  }

  for (let i = 0; i < row.cells.length - 1; i++) {
    const cell = row.cells[i];

    if (i === statusColIndex) {
      const currentValue = cell.innerText.trim();
      const optionsHTML = uniqueStatuses.map(s => 
        `<option value="${s}" ${s === currentValue ? "selected" : ""}>${s}</option>`
      ).join("");
      cell.innerHTML = `<select class="status-dropdown">${optionsHTML}</select>`;

    } else {
      cell.contentEditable = true;

      cell.addEventListener("paste", (e) => {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData("text");
        document.execCommand("insertText", false, text.trim());
      });
    }
  }

  const actionCell = row.cells[row.cells.length - 1];
  actionCell.innerHTML = `<div class="action-buttons">
    <button onclick="saveRow()">üíæ</button>
    <button onclick="cancelEdit()">‚úñ</button>
  </div>`;
}

async function saveRow() {
  if (!currentEdit) return;

  const { primaryKey, tableRowIndex, sheetName } = currentEdit; // ‚úÖ extract properly
  const table = document.querySelector("#tableContainer table");
  const row = table.rows[tableRowIndex];
  const newValues = [];

  for (let i = 0; i < row.cells.length - 1; i++) {
    const select = row.cells[i].querySelector("select");
    const value = select ? select.value.trim() : row.cells[i].innerText.trim();
    newValues.push(value);

    row.cells[i].contentEditable = false;
    row.cells[i].innerText = value; // ‚úÖ write back final value
  }

  // ‚úÖ fast UI update done ‚Äî now sync in background
  updateRow(sheetName, primaryKey, newValues).then(async () => {
    // background re-sync with sheet
    const latestData = await getSheetData(sheetName);

    // find the row we just updated
    const updatedRow = latestData.find(r => r.primaryKey === primaryKey);
    if (updatedRow) {
      // only re-render if data differs
      for (let i = 0; i < newValues.length; i++) {
        if (row.cells[i].innerText.trim() !== updatedRow.values[i].trim()) {
          renderTable(sheetName, latestData);
          break;
        }
      }
    }
  }).catch(err => {
    console.error("Save failed:", err);
    // optionally show modal if auth expired
    showAuthModal();
  });

  // ‚úÖ restore action buttons immediately
  const actionCell = row.cells[row.cells.length - 1];
  actionCell.innerHTML = `<div class="action-buttons">
      <button onclick="editRow(${primaryKey}, ${tableRowIndex}, '${sheetName}')">‚úèÔ∏è</button>
      <button onclick="deleteRowHandler(${primaryKey}, '${sheetName}')">üóëÔ∏è</button>
    </div>`;

  currentEdit = null;
}


async function cancelEdit() {
  showLoader(true);

  if (!currentEdit) return;
  const data = await getSheetData(currentEdit.sheetName); // ‚úÖ already fine
  renderTable(data, currentEdit.sheetName);
  currentEdit = null;
  showLoader(false);
}


async function deleteRowHandler(primaryKey, sheetName) {
  if (!confirm(`Are you sure you want to delete row ${primaryKey}?`)) return;
  showLoader(true);
  const data = await deleteRow(sheetName, primaryKey);
  renderTable(data, sheetName);
  showLoader(false);
}

</script>

</body>
</html>








